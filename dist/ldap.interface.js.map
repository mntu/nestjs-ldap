{"version":3,"file":"ldap.interface.js","sourceRoot":"","sources":["../lib/ldap.interface.ts"],"names":[],"mappings":";;;AAOa,QAAA,SAAS,GAAG,WAAW,CAAC;AACxB,QAAA,YAAY,GAAG,cAAc,CAAC;AAia9B,QAAA,gBAAgB,GAAG;IAC5B,uBAAuB;IAEvB,mBAAmB;IAEnB,GAAG;IACH,IAAI;IACJ,IAAI;IACJ,UAAU;IACV,SAAS;IACT,SAAS;IACT,aAAa;IACb,YAAY;IACZ,aAAa;IACb,aAAa;IACb,mBAAmB;IACnB,IAAI;IACJ,YAAY;IACZ,OAAO;IACP,WAAW;IACX,GAAG;IACH,MAAM;IACN,UAAU;IACV,YAAY;IACZ,SAAS;IACT,QAAQ;IACR,MAAM;IACN,gBAAgB;IAChB,aAAa;IACb,cAAc;IACd,gBAAgB;IAChB,YAAY;IACZ,gBAAgB;IAChB,gBAAgB;IAChB,gBAAgB;IAChB,IAAI;IACJ,IAAI;IACJ,eAAe;IACf,iBAAiB;IACjB,OAAO;IACP,aAAa;IACb,oBAAoB;IACpB,aAAa;IACb,aAAa;IACb,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,+BAA+B;IAC/B,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;IAChC,gCAAgC;CACnC,CAAC","sourcesContent":["//#region Imports NPM\r\nimport type { LoggerService } from '@nestjs/common';\r\nimport type { ModuleMetadata, Type } from '@nestjs/common/interfaces';\r\nimport type { ClientOptions, SearchEntryObject } from 'ldapjs';\r\nimport type { Redis } from 'ioredis';\r\n//#endregion\r\n\r\nexport const LDAP_SYNC = 'LDAP_SYNC';\r\nexport const LDAP_OPTIONS = 'LDAP_OPTIONS';\r\n\r\nexport type Scope = 'base' | 'one' | 'sub';\r\n\r\nexport interface LoggerContext {\r\n    [key: string]: string | unknown | null;\r\n}\r\nexport interface LdapAddEntry {\r\n    uid: string;\r\n    /**\r\n     * Common name\r\n     */\r\n    cn?: string;\r\n    displayName?: string;\r\n    name?: string;\r\n\r\n    comment?: Record<string, string> | string;\r\n\r\n    thumbnailPhoto?: Buffer;\r\n\r\n    objectClass: string | string[];\r\n\r\n    [p: string]:\r\n        | undefined\r\n        | string\r\n        | string[]\r\n        | Record<string, string>\r\n        | Buffer;\r\n}\r\n\r\nexport interface LdapModifyEntry {\r\n    uid: string;\r\n\r\n    [p: string]:\r\n        | undefined\r\n        | string\r\n        | string[]\r\n        | Record<string, string>\r\n        | Buffer;\r\n}\r\n\r\nexport interface LdapResponseObject\r\n    extends Pick<SearchEntryObject, 'dn' | 'controls'> {\r\n    /**\r\n     * Domain of this user\r\n     */\r\n    loginDomain: string;\r\n\r\n    /**\r\n     * Distinguished name\r\n     */\r\n    distinguishedName: string;\r\n\r\n    /**\r\n     * Common name\r\n     */\r\n    cn: string;\r\n\r\n    /**\r\n     * Description\r\n     */\r\n    description: string;\r\n\r\n    /**\r\n     * Display name\r\n     */\r\n    displayName: string;\r\n\r\n    /**\r\n     * Name\r\n     */\r\n    name: string;\r\n\r\n    // Object category\r\n    objectCategory: string;\r\n    objectClass: string[];\r\n    // Object GUID - ID in ldap\r\n    objectGUID: string;\r\n\r\n    /**\r\n     * SAM account name\r\n     */\r\n    sAMAccountName: string;\r\n    sAMAccountType: string;\r\n\r\n    whenChanged: Date;\r\n    whenCreated: Date;\r\n}\r\n\r\nexport type LdapResponseGroup = LdapResponseObject;\r\n\r\nexport interface LdapResponseUser extends LdapResponseObject {\r\n    /**\r\n     * Ldap response groups\r\n     */\r\n    groups: LdapResponseGroup[];\r\n\r\n    /**\r\n     * Country\r\n     */\r\n    c: string;\r\n\r\n    /**\r\n     * Country expanded\r\n     */\r\n    co: string;\r\n\r\n    /**\r\n     * Comment\r\n     */\r\n    comment: string;\r\n\r\n    /**\r\n     * Company\r\n     */\r\n    company: string;\r\n\r\n    /**\r\n     * Country code\r\n     */\r\n    countryCode: string;\r\n\r\n    /**\r\n     * Department name\r\n     */\r\n    department: string;\r\n\r\n    /**\r\n     * Employee ID\r\n     */\r\n    employeeID: string;\r\n    employeeNumber: string;\r\n    employeeType: string;\r\n\r\n    /**\r\n     * Given name\r\n     */\r\n    givenName: string;\r\n\r\n    /**\r\n     * Additional flags\r\n     */\r\n    flags: string;\r\n\r\n    /**\r\n     * Locality\r\n     */\r\n    l: string;\r\n\r\n    // Lockout time\r\n    lockoutTime: string;\r\n\r\n    // E-mail\r\n    mail: string;\r\n    otherMailbox: string[];\r\n\r\n    // Member of groups\r\n    memberOf: string[];\r\n\r\n    // middle name\r\n    middleName: string;\r\n\r\n    // Mobile phone\r\n    mobile: string;\r\n\r\n    // Manager Profile ?\r\n    manager: string;\r\n\r\n    // Other telephones\r\n    otherTelephone: string[];\r\n\r\n    // Postal code\r\n    postalCode: string;\r\n\r\n    /**\r\n     * Office name\r\n     */\r\n    physicalDeliveryOfficeName: string;\r\n\r\n    /**\r\n     * Family name\r\n     */\r\n    sn: string;\r\n\r\n    /**\r\n     * Region\r\n     */\r\n    st: string;\r\n\r\n    /**\r\n     * Street address\r\n     */\r\n    streetAddress: string;\r\n\r\n    /**\r\n     * Telephone number\r\n     */\r\n    telephoneNumber: string;\r\n\r\n    /**\r\n     * Fax number\r\n     */\r\n    facsimileTelephoneNumber: string;\r\n\r\n    /**\r\n     * Thumbnail photo\r\n     */\r\n    thumbnailPhoto: string;\r\n\r\n    /**\r\n     * Jpeg photo\r\n     */\r\n    jpegPhoto: string[];\r\n\r\n    carLicense: string;\r\n\r\n    /**\r\n     * Work title\r\n     */\r\n    title: string;\r\n\r\n    userAccountControl: string;\r\n\r\n    wWWHomePage: string;\r\n\r\n    userPrincipalName: string;\r\n\r\n    badPasswordTime: Date;\r\n    badPwdCount: number;\r\n\r\n    // Logon, logoff\r\n    logonCount: number;\r\n    lastLogoff: Date;\r\n    lastLogon: Date;\r\n    lastLogonTimestamp: Date;\r\n\r\n    pwdLastSet: Date;\r\n\r\n    /* Active Directory */\r\n    'msDS-cloudExtensionAttribute1'?: string;\r\n    'msDS-cloudExtensionAttribute2'?: string;\r\n\r\n    /* In our AD: Date of birth */\r\n    'msDS-cloudExtensionAttribute3'?: string;\r\n\r\n    'msDS-cloudExtensionAttribute4'?: string;\r\n    'msDS-cloudExtensionAttribute5'?: string;\r\n    'msDS-cloudExtensionAttribute6'?: string;\r\n    'msDS-cloudExtensionAttribute7'?: string;\r\n    'msDS-cloudExtensionAttribute8'?: string;\r\n    'msDS-cloudExtensionAttribute9'?: string;\r\n    'msDS-cloudExtensionAttribute10'?: string;\r\n    'msDS-cloudExtensionAttribute11'?: string;\r\n    'msDS-cloudExtensionAttribute12'?: string;\r\n\r\n    /* In our AD: access card (pass) */\r\n    'msDS-cloudExtensionAttribute13'?: string;\r\n\r\n    'msDS-cloudExtensionAttribute14'?: string;\r\n    'msDS-cloudExtensionAttribute15'?: string;\r\n    'msDS-cloudExtensionAttribute16'?: string;\r\n    'msDS-cloudExtensionAttribute17'?: string;\r\n    'msDS-cloudExtensionAttribute18'?: string;\r\n    'msDS-cloudExtensionAttribute19'?: string;\r\n    'msDS-cloudExtensionAttribute20'?: string;\r\n}\r\n\r\ninterface GroupSearchFilterFunction {\r\n    /**\r\n     * Construct a group search filter from user object\r\n     *\r\n     * @param user The user retrieved and authenticated from LDAP\r\n     */\r\n    (user: LdapResponseUser): string;\r\n}\r\n\r\nexport interface LdapDomainsConfig extends ClientOptions {\r\n    /**\r\n     * Name string: EXAMPLE.COM\r\n     */\r\n    name: string;\r\n\r\n    /**\r\n     * Admin connection DN, e.g. uid=myapp,ou=users,dc=example,dc=org.\r\n     * If not given at all, admin client is not bound. Giving empty\r\n     * string may result in anonymous bind when allowed.\r\n     *\r\n     * Note: Not passed to ldapjs, it would bind automatically\r\n     */\r\n    bindDN: string;\r\n    /**\r\n     * Password for bindDN\r\n     */\r\n    bindCredentials: string;\r\n    /**\r\n     * Property of the LDAP user object to use when binding to verify\r\n     * the password. E.g. name, email. Default: dn\r\n     */\r\n    bindProperty?: 'dn';\r\n\r\n    /**\r\n     * The base DN from which to search for users by username.\r\n     * E.g. ou=users,dc=example,dc=org\r\n     */\r\n    searchBase: string;\r\n    /**\r\n     * LDAP search filter with which to find a user by username, e.g.\r\n     * (uid={{username}}). Use the literal {{username}} to have the\r\n     * given username interpolated in for the LDAP search.\r\n     */\r\n    searchFilter: string;\r\n    /**\r\n     * Scope of the search. Default: 'sub'\r\n     */\r\n    searchScope?: Scope;\r\n    /**\r\n     * Array of attributes to fetch from LDAP server. Default: all\r\n     */\r\n    searchAttributes?: string[];\r\n\r\n    /**\r\n     * LDAP synchronization\r\n     */\r\n    hideSynchronization?: boolean;\r\n\r\n    /**\r\n     * LDAP search filter with synchronization.\r\n     */\r\n    searchFilterAllUsers?: string;\r\n    /**\r\n     * Scope of the search. Default: 'sub'\r\n     */\r\n    searchScopeAllUsers?: Scope;\r\n    /**\r\n     * Array of attributes to fetch from LDAP server. Default: all\r\n     */\r\n    searchAttributesAllUsers?: string[];\r\n\r\n    /**\r\n     * The base DN from which to search for groups. If defined,\r\n     * also groupSearchFilter must be defined for the search to work.\r\n     */\r\n    groupSearchBase?: string;\r\n    /**\r\n     * LDAP search filter for groups. Place literal {{dn}} in the filter\r\n     * to have it replaced by the property defined with `groupDnProperty`\r\n     * of the found user object. Optionally you can also assign a\r\n     * function instead. The found user is passed to the function and it\r\n     * should return a valid search filter for the group search.\r\n     */\r\n    groupSearchFilter?: string | GroupSearchFilterFunction;\r\n    searchFilterAllGroups?: string;\r\n    /**\r\n     * Scope of the search. Default: sub\r\n     */\r\n    groupSearchScope?: Scope;\r\n    /**\r\n     * Array of attributes to fetch from LDAP server. Default: all\r\n     */\r\n    groupSearchAttributes?: string[];\r\n\r\n    /**\r\n     * The property of user object to use in '{{dn}}' interpolation of\r\n     * groupSearchFilter. Default: 'dn'\r\n     */\r\n    groupDnProperty?: string;\r\n\r\n    /**\r\n     * Set to true to add property '_raw' containing the original buffers\r\n     * to the returned user object. Useful when you need to handle binary\r\n     * attributes\r\n     */\r\n    includeRaw?: boolean;\r\n\r\n    timeLimit?: number;\r\n    sizeLimit?: number;\r\n\r\n    /**\r\n     * Where new objects (contacts, users) to place\r\n     */\r\n    newObject?: string;\r\n}\r\n\r\nexport interface LdapModuleOptions {\r\n    /**\r\n     * Domains config\r\n     */\r\n    domains: LdapDomainsConfig[];\r\n\r\n    /**\r\n     * Logging options\r\n     */\r\n    logger: LoggerService;\r\n\r\n    /**\r\n     * If true, then up to 100 credentials at a time will be cached for\r\n     * 5 minutes.\r\n     */\r\n    cache?: Redis;\r\n    cacheUrl?: string;\r\n    cacheTtl?: number;\r\n}\r\n\r\nexport interface LdapOptionsFactory {\r\n    createLdapOptions(): Promise<LdapModuleOptions> | LdapModuleOptions;\r\n}\r\n\r\nexport interface LdapModuleAsyncOptions\r\n    extends Pick<ModuleMetadata, 'imports'> {\r\n    useExisting?: Type<LdapOptionsFactory>;\r\n    useClass?: Type<LdapOptionsFactory>;\r\n    useFactory?: (\r\n        ...args: any[]\r\n    ) => Promise<LdapModuleOptions> | LdapModuleOptions;\r\n    inject?: any[];\r\n}\r\n\r\nexport const ldapADattributes = [\r\n    'thumbnailPhoto;binary',\r\n    // 'jpegPhoto;binary',\r\n    'objectGUID;binary',\r\n    // 'objectSid;binary',\r\n    'c',\r\n    'cn',\r\n    'co',\r\n    'codePage',\r\n    'comment',\r\n    'company',\r\n    'countryCode',\r\n    'department',\r\n    'description',\r\n    'displayName',\r\n    'distinguishedName',\r\n    'dn',\r\n    'employeeID',\r\n    'flags',\r\n    'givenName',\r\n    'l',\r\n    'mail',\r\n    'memberOf',\r\n    'middleName',\r\n    'manager',\r\n    'mobile',\r\n    'name',\r\n    'objectCategory',\r\n    'objectClass',\r\n    'otherMailbox',\r\n    'otherTelephone',\r\n    'postalCode',\r\n    'primaryGroupID',\r\n    'sAMAccountName',\r\n    'sAMAccountType',\r\n    'sn',\r\n    'st',\r\n    'streetAddress',\r\n    'telephoneNumber',\r\n    'title',\r\n    'wWWHomePage',\r\n    'userAccountControl',\r\n    'whenChanged',\r\n    'whenCreated',\r\n    'msDS-cloudExtensionAttribute1',\r\n    'msDS-cloudExtensionAttribute2',\r\n    'msDS-cloudExtensionAttribute3',\r\n    'msDS-cloudExtensionAttribute4',\r\n    'msDS-cloudExtensionAttribute5',\r\n    'msDS-cloudExtensionAttribute6',\r\n    'msDS-cloudExtensionAttribute7',\r\n    'msDS-cloudExtensionAttribute8',\r\n    'msDS-cloudExtensionAttribute9',\r\n    'msDS-cloudExtensionAttribute10',\r\n    'msDS-cloudExtensionAttribute11',\r\n    'msDS-cloudExtensionAttribute12',\r\n    'msDS-cloudExtensionAttribute13',\r\n    'msDS-cloudExtensionAttribute14',\r\n    'msDS-cloudExtensionAttribute15',\r\n    'msDS-cloudExtensionAttribute16',\r\n    'msDS-cloudExtensionAttribute17',\r\n    'msDS-cloudExtensionAttribute18',\r\n    'msDS-cloudExtensionAttribute19',\r\n    'msDS-cloudExtensionAttribute20',\r\n];\r\n\r\nexport interface LDAPCache {\r\n    user: LdapResponseUser;\r\n    password: string;\r\n}\r\n"]}